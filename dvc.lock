schema: '2.0'
stages:
  produce_tiles_DURA_EUROPOS:
    cmd: python src/alceo/processing/produce_tiles.py -i data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif -o data/sites/DURA_EUROPOS/tiles.json
      -p DURA_EUROPOS_
    deps:
    - path: data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      md5: 60cfa7d954df7d8f305366116203b284
      size: 1208292462
    - path: data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif
      md5: 658d47fbf2225d11f782f7f569ead44d
      size: 1187955310
    - path: src/alceo/processing/produce_tiles.py
      md5: e9ce967ae719b1003b1d4e1f60f2eb26
      size: 3808
    outs:
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 271794011c0c5686aa8999d22e1e465d
      size: 178170
  rasterize_tiles_DURA_EUROPOS:
    cmd: python src/alceo/processing/rasterize_tiles.py -t data/sites/DURA_EUROPOS/tiles.json
      -i data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      -a data/sites/DURA_EUROPOS/area_of_interest.geojson -o data/sites/DURA_EUROPOS/tiles/DE_19_09_2014/DE_19_09_2014_NN_diffuse
    deps:
    - path: data/sites/DURA_EUROPOS/area_of_interest.geojson
      md5: 6db7aa1ffe2fc97f118167209b908975
      size: 1107
    - path: data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      md5: 60cfa7d954df7d8f305366116203b284
      size: 1208292462
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 17d2d670c2da8fdf98b123152bd92d54
      size: 178170
    - path: src/alceo/processing/rasterize_tiles.py
      md5: e77a6f9ca5ac7d84726ff0b84df5ad17
      size: 5081
    outs:
    - path: data/sites/DURA_EUROPOS/tiles/DE_19_09_2014/DE_19_09_2014_NN_diffuse
      md5: cbec4188df97b533faae4bbc55db96a8.dir
      size: 839632800
      nfiles: 400
  rasterize_tiles_DURA_EUROPOS_:
    cmd: python src/alceo/processing/rasterize_tiles.py -t data/sites/DURA_EUROPOS/tiles.json
      -i data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif -a
      data/sites/DURA_EUROPOS/area_of_interest.geojson -o data/sites/DURA_EUROPOS/tiles/DE_26_5_2013/DE_26_5_2013_NN_diffuse
    deps:
    - path: data/sites/DURA_EUROPOS/area_of_interest.geojson
      md5: 6db7aa1ffe2fc97f118167209b908975
      size: 1107
    - path: data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif
      md5: 658d47fbf2225d11f782f7f569ead44d
      size: 1187955310
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 17d2d670c2da8fdf98b123152bd92d54
      size: 178170
    - path: src/alceo/processing/rasterize_tiles.py
      md5: e77a6f9ca5ac7d84726ff0b84df5ad17
      size: 5081
    outs:
    - path: data/sites/DURA_EUROPOS/tiles/DE_26_5_2013/DE_26_5_2013_NN_diffuse
      md5: ba4ff4d04c9982edfda9d618327c1923.dir
      size: 839632800
      nfiles: 400
  tilize_image@0:
    cmd: python src/alceo/processing/rasterize_tiles.py -t data/sites/DURA_EUROPOS/tiles.json
      -i data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      -o data/sites/DURA_EUROPOS/tiles/DE_19_09_2014/DE_19_09_2014_NN_diffuse
    deps:
    - path: data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      md5: 60cfa7d954df7d8f305366116203b284
      size: 1208292462
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 20659f8b36f263be91b4047238dcf30b
      size: 122592
    - path: src/alceo/processing/rasterize_tiles.py
      md5: e77a6f9ca5ac7d84726ff0b84df5ad17
      size: 5081
    outs:
    - path: data/sites/DURA_EUROPOS/tiles/DE_19_09_2014/DE_19_09_2014_NN_diffuse
      md5: af13c2669efc1822718b836c5e289a32.dir
      size: 818641980
      nfiles: 390
  tilize_image@1:
    cmd: python src/alceo/processing/rasterize_tiles.py -t data/sites/DURA_EUROPOS/tiles.json
      -i data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif -o
      data/sites/DURA_EUROPOS/tiles/DE_26_5_2013/DE_26_5_2013_NN_diffuse
    deps:
    - path: data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif
      md5: 658d47fbf2225d11f782f7f569ead44d
      size: 1187955310
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 20659f8b36f263be91b4047238dcf30b
      size: 122592
    - path: src/alceo/processing/rasterize_tiles.py
      md5: e77a6f9ca5ac7d84726ff0b84df5ad17
      size: 5081
    outs:
    - path: data/sites/DURA_EUROPOS/tiles/DE_26_5_2013/DE_26_5_2013_NN_diffuse
      md5: 0b47e0b1e8ce069dbbb7033dac8c10b3.dir
      size: 818641980
      nfiles: 390
  change_annotations_DE_26_5_2013_DE_19_09_2014:
    cmd: python src/alceo/processing/change_from_annotations.py -i data/sites/DURA_EUROPOS/annotations/pits.geojson
      -f 26/5/2013 -s 19/09/2014 -o data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial
      --crs EPSG:32637
    deps:
    - path: data/sites/DURA_EUROPOS/annotations/pits.geojson
      md5: 0a6adb41e885688ff236df0524ad611b
      size: 2727276
    - path: src/alceo/processing/change_from_annotations.py
      md5: 709b58d7f45e1e8f131c3ed0c14c2d2e
      size: 6581
    outs:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial
      md5: 12153c8eea2a3edcb98907080521658e.dir
      size: 3295400
      nfiles: 3
  rasterize_change@1:
    cmd: mkdir -p data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/
      & rio rasterize data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial/pits.disappeared.geojson
      --like data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif
      --output data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.disappeared.tif
    deps:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial/pits.disappeared.geojson
      md5: 7037732e5b533abc683ce262d4f2a185
      size: 782012
    - path: data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif
      md5: 658d47fbf2225d11f782f7f569ead44d
      size: 1187955310
    outs:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.disappeared.tif
      md5: e495d8feeb4071cf4ec9e0aa9a203151
      size: 296967600
  rasterize_change@0:
    cmd: mkdir -p data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/
      & rio rasterize data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial/pits.appeared.geojson
      --like data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif
      --output data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.appeared.tif
    deps:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial/pits.appeared.geojson
      md5: 1c99717cea6c2346419a3f96bcbcf69e
      size: 5288708
    - path: data/sites/DURA_EUROPOS/images/DE_26_5_2013/DE_26_5_2013_NN_diffuse.tif
      md5: 658d47fbf2225d11f782f7f569ead44d
      size: 1187955310
    outs:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.appeared.tif
      md5: 4d27bcdc6909241d1ee336c8e9b20ea0
      size: 296967600
  change_annotations@0:
    cmd: python src/alceo/processing/change_from_annotations.py -i data/sites/DURA_EUROPOS/annotations/pits.geojson
      -f 26/05/2013 -s 19/09/2014 -o data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial
      --crs EPSG:32637
    deps:
    - path: data/sites/DURA_EUROPOS/annotations/pits.geojson
      md5: 75a3bf5db4c52d1d0ccbb8027c519eff
      size: 6178153
    - path: src/alceo/processing/change_from_annotations.py
      md5: 709b58d7f45e1e8f131c3ed0c14c2d2e
      size: 6581
    outs:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/vectorial
      md5: 688d6dc4b839566b45c74532bf6b7a97.dir
      size: 7219281
      nfiles: 3
  tilize_change@0:
    cmd: mkdir -p data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.appeared/tiles
      & python src/alceo/processing/rasterize_tiles.py -t data/sites/DURA_EUROPOS/tiles.json
      -i data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.appeared.tif
      -a data/sites/DURA_EUROPOS/area_of_interest.geojson -o data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.appeared/tiles
    deps:
    - path: data/sites/DURA_EUROPOS/area_of_interest.geojson
      md5: 6db7aa1ffe2fc97f118167209b908975
      size: 1107
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.appeared.tif
      md5: 4d27bcdc6909241d1ee336c8e9b20ea0
      size: 296967600
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 20659f8b36f263be91b4047238dcf30b
      size: 122592
    - path: src/alceo/processing/rasterize_tiles.py
      md5: e77a6f9ca5ac7d84726ff0b84df5ad17
      size: 5081
    outs:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.appeared/tiles
      md5: 9f9511fc82523dcddea814cce0decf23.dir
      size: 204762480
      nfiles: 390
  tilize_change@1:
    cmd: mkdir -p data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.disappeared/tiles
      & python src/alceo/processing/rasterize_tiles.py -t data/sites/DURA_EUROPOS/tiles.json
      -i data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.disappeared.tif
      -a data/sites/DURA_EUROPOS/area_of_interest.geojson -o data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.disappeared/tiles
    deps:
    - path: data/sites/DURA_EUROPOS/area_of_interest.geojson
      md5: 6db7aa1ffe2fc97f118167209b908975
      size: 1107
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.disappeared.tif
      md5: e495d8feeb4071cf4ec9e0aa9a203151
      size: 296967600
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 20659f8b36f263be91b4047238dcf30b
      size: 122592
    - path: src/alceo/processing/rasterize_tiles.py
      md5: e77a6f9ca5ac7d84726ff0b84df5ad17
      size: 5081
    outs:
    - path: data/sites/DURA_EUROPOS/change/DE_26_5_2013/DE_19_09_2014/raster/pits.disappeared/tiles
      md5: 07c37fb242739a55330dc5ae089d7e25.dir
      size: 204762480
      nfiles: 390
  produce_tiles@0:
    cmd: python src/alceo/processing/produce_tiles.py -i data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      -p DURA_EUROPOS_ -a data/sites/DURA_EUROPOS/area_of_interest.geojson -o data/sites/DURA_EUROPOS/tiles.json
    deps:
    - path: data/sites/DURA_EUROPOS/area_of_interest.geojson
      md5: 6db7aa1ffe2fc97f118167209b908975
      size: 1107
    - path: data/sites/DURA_EUROPOS/images/DE_19_09_2014/DE_19_09_2014_NN_diffuse.tif
      md5: 60cfa7d954df7d8f305366116203b284
      size: 1208292462
    - path: src/alceo/processing/produce_tiles.py
      md5: 3f2d3b8f3608d600662ae22a6e1d66d8
      size: 4748
    outs:
    - path: data/sites/DURA_EUROPOS/tiles.json
      md5: 20659f8b36f263be91b4047238dcf30b
      size: 122592
  fit_siam_diff:
    cmd: python -m alceo fit --config cli_config/daudt_siam_diff.yaml
    deps:
    - path: cli_config/daudt_siam_diff.yaml
      md5: 3ff38252ffc84dddff43b2798b1d9396
      size: 1538
    - path: dataset/pits/test_ASWAN
      md5: f4003e4c55a601de1d7330a377f8ec7e.dir
      size: 111866890
      nfiles: 338
    - path: dataset/pits/test_DURA_EUROPOS
      md5: c6ae12b7103a38405604a387793d5b93.dir
      size: 573287130
      nfiles: 1738
    - path: dataset/pits/test_EBLA
      md5: da637b8a80f9f8c804527604539a8620.dir
      size: 199289453
      nfiles: 506
    - path: dataset/pits/train_ASWAN
      md5: 0ea79f32d0e8189a9e5e43b82d5a61d9.dir
      size: 1100366704
      nfiles: 3350
    - path: dataset/pits/train_DURA_EUROPOS
      md5: caa81d7bf1ee9d32290452003d1057d7.dir
      size: 1718048022
      nfiles: 5222
    - path: dataset/pits/train_EBLA
      md5: b9b7fa0044dc6bd9e176c256154809cf.dir
      size: 709843200
      nfiles: 1802
    - path: src
      md5: 68863095ebf7c0ae9b4913250568888e.dir
      size: 116266
      nfiles: 43
    params:
      cli_config/daudt_siam_diff.yaml:
        data:
          batch_size: 24
          train_paths:
          - dataset/pits/train_DURA_EUROPOS
          - dataset/pits/train_ASWAN
          - dataset/pits/train_EBLA
          validation_paths:
          - dataset/pits/test_DURA_EUROPOS
          - dataset/pits/test_ASWAN
          - dataset/pits/test_EBLA
          validation_labels:
          - DURA_EUROPOS
          - ASWAN
          - EBLA
        lr_scheduler:
          class_path: pytorch_lightning.cli.ReduceLROnPlateau
          init_args:
            mode: max
            monitor: validation/appeared/IoU
            factor: 0.95
        model:
          network:
            class_path: alceo.model.SiamUnet_diff
            init_args:
              input_nbr: 4
              label_nbr: 2
          loss_fn:
            class_path: segmentation_models_pytorch.losses.JaccardLoss
            init_args:
              mode: multilabel
        optimizer:
          class_path: torch.optim.Adam
          init_args:
            lr: 0.0001
            weight_decay: 0.0001
    outs:
    - path: change_detection_logs/DvcLiveLogger/daudt_siam_diff/checkpoints/best_IoU.ckpt
      md5: dcd1b48e31a17574442e038bb458ebbc
      size: 16340829
    - path: change_detection_logs/metrics.json
      md5: 34ce7ad1b4cfc4d4ed96b9b552a19c7d
      size: 3574
    - path: change_detection_logs/plots
      md5: d86196edea2e4fa3e7d1827f93b05954.dir
      size: 3158186
      nfiles: 70
  predict_siam_diff_DURA:
    cmd:
    - python -m alceo predict --config cli_config/daudt_siam_diff.yaml --ckpt_path
      change_detection_logs/DvcLiveLogger/daudt_siam_diff/checkpoints/best_IoU.ckpt
      --trainer.callbacks+=alceo.callback.TiffPredictionWriter --trainer.callbacks.init_args.output_dir=change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014
      --data.predict_paths+=dataset/pits/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014 --data.predict_labels+=DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014
    - rio merge change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/activation/*.tif
      -o change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/activation.tif
      --overwrite
    - rio merge change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/mask/*.tif
      -o change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/mask.tif
      --overwrite
    - rio shapes --projected --as-mask --bidx 1 change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/mask.tif
      -o change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/appeared.geojson
    - rio shapes --projected --as-mask --bidx 2 change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/mask.tif
      -o change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014/disappeared.geojson
    deps:
    - path: change_detection_logs/DvcLiveLogger/daudt_siam_diff/checkpoints/best_IoU.ckpt
      md5: dcd1b48e31a17574442e038bb458ebbc
      size: 16340829
    - path: cli_config/daudt_siam_diff.yaml
      md5: 348856a2db989fd4ed471e685a186a34
      size: 1408
    - path: dataset/pits/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014
      md5: 56640bfd7e461970034788ae84372c92.dir
      size: 2258632533
      nfiles: 6862
    outs:
    - path: change_detection_inference/DURA_EUROPOS_DE_26_5_2013-DE_19_09_2014
      md5: f76b708924e17a7927a93827b10060c0.dir
      size: 2317970016
      nfiles: 3434
