
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../modeling/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>Data sub-system - ALCEO Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#data-management-sub-system" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ALCEO Docs" class="md-header__button md-logo" aria-label="ALCEO Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ALCEO Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Data sub-system
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ALCEO Docs" class="md-nav__button md-logo" aria-label="ALCEO Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    ALCEO Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Data sub-system
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Data sub-system
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#site-data-directory" class="md-nav__link">
    Site data directory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#site-data-pipeline" class="md-nav__link">
    Site data pipeline
  </a>
  
    <nav class="md-nav" aria-label="Site data pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#produce-a-vectorial-representation-of-tiles" class="md-nav__link">
    Produce a vectorial representation of tiles.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#computing-change-from-site-annotations" class="md-nav__link">
    Computing change from site annotations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rasterizing-vectorial-change-representations" class="md-nav__link">
    Rasterizing vectorial change representations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rasters-tilization" class="md-nav__link">
    Rasters tilization
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataset-compilation" class="md-nav__link">
    Dataset compilation
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../modeling/" class="md-nav__link">
        Modeling sub-system
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Code Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Code Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../reference/alceo/">alceo</a>
          
            <label for="__nav_4_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          alceo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_2" >
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../reference/alceo/callback/">callback</a>
          
            <label for="__nav_4_1_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_2">
          <span class="md-nav__icon md-icon"></span>
          callback
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/callback/tiff_prediction_writer/" class="md-nav__link">
        tiff_prediction_writer
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_3" >
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../reference/alceo/data_module/">data_module</a>
          
            <label for="__nav_4_1_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_3">
          <span class="md-nav__icon md-icon"></span>
          data_module
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/data_module/change_detection/" class="md-nav__link">
        change_detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/data_module/phase_data_module/" class="md-nav__link">
        phase_data_module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/data_module/segmentation/" class="md-nav__link">
        segmentation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_4" >
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../reference/alceo/dataset/">dataset</a>
          
            <label for="__nav_4_1_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_4">
          <span class="md-nav__icon md-icon"></span>
          dataset
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/dataset/change_detection/" class="md-nav__link">
        change_detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/dataset/second/" class="md-nav__link">
        second
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/dataset/segmentation/" class="md-nav__link">
        segmentation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_5" >
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../reference/alceo/logger/">logger</a>
          
            <label for="__nav_4_1_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_5">
          <span class="md-nav__icon md-icon"></span>
          logger
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/logger/dvc/" class="md-nav__link">
        dvc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_6" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../reference/alceo/model/">model</a>
          
            <label for="__nav_4_1_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_6">
          <span class="md-nav__icon md-icon"></span>
          model
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/model/alceo_change_detection_module/" class="md-nav__link">
        alceo_change_detection_module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/model/alceo_segmentation_module/" class="md-nav__link">
        alceo_segmentation_module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/model/phase_metric_module/" class="md-nav__link">
        phase_metric_module
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/model/siam_diff/" class="md-nav__link">
        siam_diff
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_7" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../reference/alceo/processing/">processing</a>
          
            <label for="__nav_4_1_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1_7">
          <span class="md-nav__icon md-icon"></span>
          processing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/processing/change_from_annotations/" class="md-nav__link">
        change_from_annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/processing/pits_site_dataset/" class="md-nav__link">
        pits_site_dataset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/processing/produce_tiles/" class="md-nav__link">
        produce_tiles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/processing/rasterize_tiles/" class="md-nav__link">
        rasterize_tiles
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reference/alceo/utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#site-data-directory" class="md-nav__link">
    Site data directory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#site-data-pipeline" class="md-nav__link">
    Site data pipeline
  </a>
  
    <nav class="md-nav" aria-label="Site data pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#produce-a-vectorial-representation-of-tiles" class="md-nav__link">
    Produce a vectorial representation of tiles.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#computing-change-from-site-annotations" class="md-nav__link">
    Computing change from site annotations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rasterizing-vectorial-change-representations" class="md-nav__link">
    Rasterizing vectorial change representations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rasters-tilization" class="md-nav__link">
    Rasters tilization
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataset-compilation" class="md-nav__link">
    Dataset compilation
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="data-management-sub-system">Data Management Sub-system</h1>
<p>This sub-system is in charge of producing the datasets used to train and evaluate the project's models starting from satellite imagery data and human annotation of the looting activity. 
Most machine learning models for computer vision tasks, such as the ones developed for this project, work directly on raster data.
This pre-processing procedure consists of tools executed in a precise sequence. Such a sequence is called a pipeline.  </p>
<h2 id="site-data-directory">Site data directory</h2>
<p>For each site, a pre-processing pipeline has been configured. All the site data and the pipeline configuration are stored inside the <code>data/site/&lt;SITE NAME&gt;</code> folder.
The data pipeline's main objective is the production of all intermediate artifacts for the final dataset, which depends on the site's images and annotations.</p>
<p>The setup of a site's data directory starts with the following components:
1. Area of Interest GeoJSON (e.g., <code>area_of_interest.geojson</code>) describes the site's boundaries that the sub-system should process.<br />
2. Annotations GeoJSON containing the polygons delimiting the looting pits. Each pit should have a "Day_Month_Year" string to identify the date the looting pit was visible, <code>alceo.preprocessing.change_from_annotation</code> script will also use this date. (e.g., <code>annotations/pits.geojson</code>)</p>
<!-- 3. Training and Testing GeoJSON (e.g., `training_area.geojson` and `test_area.geojson`) delimiting the areas for creating training and test datasets with a geographical split. -->
<ol>
<li>Geo-referenced satellite image. The image's supported format is GeoTIFF. Using a folder for each GeoTIFF can be helpful to keep a tidy folder structure when other tools (e.g., QGIS) create meta-data files. </li>
<li><code>dvc.yaml</code> file describing the site's data pipeline stages. The following section describes setting it up using the <a href="https://dvc.org/doc/command-reference/stage"><code>dvc stage</code></a> command.</li>
</ol>
<p>The resulting example site data directory follows:</p>
<pre><code>data/
    sites/
        &lt;SITE NAME&gt;/
            annotations/ # contains annotation files (i.e. pits.geojson).
                pits.geojson
            images/ # contains images products.
                &lt;IMAGE NAME&gt;/
                    image_name.tiff # image file with an example name.
            dvc.yaml # configuration of the site level pipeline.
</code></pre>
<h2 id="site-data-pipeline">Site data pipeline</h2>
<p>The site data pipeline is in charge of splitting the areas of interest into geo-referenced tiles, computing from the site annotations the change in looting pits (appearance and disappearance) between two dates and cutting all rasters (images and change binary masks) in tiles of the exact resolution.
DVC is the tool we've chosen to produce this pipeline.</p>
<h3 id="produce-a-vectorial-representation-of-tiles">Produce a vectorial representation of tiles.</h3>
<p>The script <code>alceo.processing.produce_tiles</code> produces a GeoJSON containing polygons georeferencing all the vectorial tiles of a site's areas of interest.
The produced GeoJSON includes metadata about the resulting raster resolution and a generated identifier of the tile.</p>
<p>Creating the stage using the <code>dvc stage add</code> command:</p>
<pre><code class="language-bash">cd data/sites/${site_name} # Get into the site data directory to generate the dvc.yaml file. 

# The -w flag is needed to give the stage the project root as work directory.
dvc stage add -n produce_vectorial_tiles \
-w ../../../. \
-d src/alceo/processing/produce_tiles.py \
-d data/sites/${site_name}/images/${image_path} \
-d data/sites/${site_name}/area_of_interest.geojson \
-o data/sites/${site_name}/tiles.geojson \
python src/alceo/processing/produce_tiles.py \
      -i data/sites/${site_name}/images/${images_path} \
      -p ${tile_prefix} \
      -a data/sites/${site_name}/area_of_interest.geojson \
      -tw 256 \
      -th 256 \
      -o data/sites/${site_name}/tiles.geojson
</code></pre>
<p>Executing this command will result in the generation of the following <code>dvc.yaml</code> file:</p>
<pre><code class="language-yaml">stages:
  produce_vectorial_tiles:
    wdir: ../../../.
    cmd: python src/alceo/processing/produce_tiles.py
      -i data/sites/${site_name}/images/${images_path}
      -p ${tile_prefix}
      -a data/sites/${site_name}/area_of_interest.geojson
      -tw 256
      -th 256
      -o data/sites/${site_name}/tiles.geojson
    deps:
      - src/alceo/processing/produce_tiles.py
      - data/sites/${site_name}/images/${images_path}
      - data/sites/${site_name}/area_of_interest.geojson
    outs:
      - data/sites/${site_name}/tiles.geojson
</code></pre>
<p>The <code>outs</code> field of a stage definition represents the files generated by the stage, whereas <code>deps</code> are the files on which the command's output depends. In this way, DVC can compute how the stages depend on each other in the pipeline and avoid re-computing parts for which the dependencies did not change (and thus, the outputs should remain the same).</p>
<p>DVC has templating functionalities that allow the parametric definition of stages. In the previous stage, <code>${site_name}</code>, <code>${image_path}</code>, and <code>${tile_prefix}</code> are examples of DVC <a href="https://dvc.org/doc/user-guide/project-structure/dvcyaml-files#templating">templating</a>. </p>
<h3 id="computing-change-from-site-annotations">Computing change from site annotations</h3>
<p>A crucial step in the pipeline is the computation of the appearance and the disappearance of looting pits from the annotations of images taken on two dates. 
The script <code>alceo.preprocessing.change_from_annotations.py</code> takes the annotations GeoJSON for a site and the two dates of interest. Then the script computes features corresponding to looting pits' <code>appearance</code>, <code>disappearance</code>, and <code>permanence</code> and saves them into a target folder as three files in GeoJSON format.</p>
<p>In the site's <code>dvc.yaml</code> file this stage is defined as:</p>
<pre><code class="language-yaml">stage:
    ...
    produce_vectorial_change:
        wdir: ../../../. # workdir is the project root directory.
        cmd: python src/alceo/processing/change_from_annotations.py
            -i data/sites/${site_name}/annotations/pits.geojson
            -f ${first.date} -s ${second.date}
            -o data/sites/${site_name}/change/${first.image_folder}/${second.image_folder}/vectorial # arbitrary folder path
            --crs ${crs}
        deps:
            - src/alceo/processing/change_from_annotations.py
            - data/sites/${site_name}/annotations/pits.geojson
        outs:
            - data/sites/${site_name}/change/${first.image_folder}/${second.image_folder}/vectorial
</code></pre>
<p>If the site's images compose a time series of more than two dates, multiple pipeline stages of this kind can be defined using templating's <a href="https://dvc.org/doc/user-guide/project-structure/dvcyaml-files#foreach-stages">foreach stages</a> construct.</p>
<pre><code class="language-yaml">vars:
  - site_name: SITE
  - images:
      - name: DATE_A
        path: DATE_A/DATE_A_QB_NN_diffuse_geo.tif
      - name: DATE_B
        path: DATE_B/DATE_B_NN_diffuse_geo.tif
      - name: DATE_C
        path: DATE_C/DATE_C_NN_diffuse.tif
  - change_steps:
      - change: DATE_A/DATE_B
        crs: &quot;EPSG:32636&quot;
        first:
          date: &quot;04/08/2005&quot;
          image_folder: DATE_A
        second:
          date: &quot;05/10/2015&quot;
          image_folder: DATE_B
      - change: DATE_B/DATE_C
        crs: &quot;EPSG:32636&quot;
        first:
          date: &quot;05/10/2015&quot;
          image_folder: DATE_B
        second:
          date: &quot;20/03/2018&quot;
          image_folder: DATE_C
      - change: DATE_A/DATE_C
        crs: &quot;EPSG:32636&quot;
        first:
          date: &quot;04/08/2005&quot;
          image_folder: DATE_A
        second:
          date: &quot;20/03/2018&quot;
          image_folder: DATE_C
stages:
    ...
    produce_vectorial_change:
        foreach: ${change_steps}
        do:
        wdir: ../../../.
        cmd: python src/alceo/processing/change_from_annotations.py
            -i data/sites/${site_name}/annotations/pits.geojson
            -f ${item.first.date} -s ${item.second.date}
            -o data/sites/${site_name}/change/${item.first.image_folder}/${item.second.image_folder}/vectorial
            --crs ${item.crs}
        deps:
            - src/alceo/processing/change_from_annotations.py
            - data/sites/${site_name}/annotations/pits.geojson
        outs:
            - data/sites/${site_name}/change/${item.first.image_folder}/${item.second.image_folder}/vectorial
</code></pre>
<h3 id="rasterizing-vectorial-change-representations">Rasterizing vectorial change representations</h3>
<p>The next stage of the pipeline is to obtain a raster from the change vectorial features just computed. Rasterio's <a href="https://rasterio.readthedocs.io/en/stable/cli.html#rasterize"><code>rio rasterize</code></a> command allows for the rasterization of GeoJSON features. In compliance with the <a href="http://www.captain-whu.com/project/SCD/">SECOND</a>'s structure, a stage is defined for rasterizing each change feature into a binary mask. </p>
<pre><code class="language-yaml">vars:
  - change_kinds:
    - change: DATE_A/DATE_B
        base_image: DATE_A/DATE_A_QB_NN_diffuse_geo
        kind: pits.appeared
    - change: DATE_A/DATE_B
        base_image: DATE_A/DATE_A_QB_NN_diffuse_geo
        kind: pits.disappeared
    - change: DATE_B/DATE_C
        base_image: DATE_B/DATE_B_NN_diffuse_geo
        kind: pits.appeared
    - change: DATE_B/DATE_C
        base_image: DATE_B/DATE_B_NN_diffuse_geo
        kind: pits.disappeared
    - change: DATE_A/DATE_C
        base_image: DATE_A/DATE_A_QB_NN_diffuse_geo
        kind: pits.appeared
    - change: DATE_A/DATE_C
        base_image: DATE_A/DATE_A_QB_NN_diffuse_geo
        kind: pits.disappeared 
stages:
  ...
  rasterize_change:
    foreach: ${change_kinds}
    do:
      wdir: ../../../.
      cmd:
        - mkdir -p data/sites/${site_name}/change/${item.change}/raster/
        - rio rasterize
          data/sites/${site_name}/change/${item.change}/vectorial/${item.kind}.geojson
          --like data/sites/${site_name}/images/${item.base_image}.tif
          --output data/sites/${site_name}/change/${item.change}/raster/${item.kind}.tif
      deps:
        - data/sites/${site_name}/change/${item.change}/vectorial/${item.kind}.geojson
        - data/sites/${site_name}/images/${item.base_image}.tif
      outs:
        - data/sites/${site_name}/change/${item.change}/raster/${item.kind}.tif
</code></pre>
<h3 id="rasters-tilization">Rasters tilization</h3>
<p>The last step in the data pre-processing pipeline is to split all the rasters (images and annotated features) into georeferenced tiles. The <code>alceo.processing.rasterize_tiles</code> script tilizes and resamples an input raster following the vectorial representation of tiles of the site's areas of interest.</p>
<p>This is done with the following stages:</p>
<pre><code class="language-yaml">vars:
  ...
stages:
  ...
  tilize_image:
    foreach: ${images}
    do:
      wdir: ../../../.
      cmd: python src/alceo/processing/rasterize_tiles.py
        -t data/sites/${site_name}/tiles.geojson
        -i data/sites/${site_name}/images/${item.path}
        -o data/sites/${site_name}/tiles/${item.name}
      deps:
        - src/alceo/processing/rasterize_tiles.py
        - data/sites/${site_name}/tiles.geojson
        - data/sites/${site_name}/images/${item.path}
      outs:
        - data/sites/${site_name}/tiles/${item.name}/
  tilize_change:
    foreach: ${change_kinds}
    do:
      wdir: ../../../.
      cmd:
        - mkdir -p data/sites/${site_name}/change/${item.change}/raster/${item.kind}/tiles
        - python src/alceo/processing/rasterize_tiles.py
          -t data/sites/${site_name}/tiles.geojson
          -i data/sites/${site_name}/change/${item.change}/raster/${item.kind}.tif
          -o data/sites/${site_name}/change/${item.change}/raster/${item.kind}/tiles
      deps:
        - src/alceo/processing/rasterize_tiles.py
        - data/sites/${site_name}/tiles.geojson
        - data/sites/${site_name}/change/${item.change}/raster/${item.kind}.tif
      outs:
        - data/sites/${site_name}/change/${item.change}/raster/${item.kind}/tiles
</code></pre>
<h2 id="dataset-compilation">Dataset compilation</h2>
<p>The last stage in the Data Management Sub-system pipeline is compiling the various datasets for change detection. The <code>alceo.processing.pits_site_dataset</code> script takes all the pre-processed data in the data directory and outputs a dataset compliant with the <a href="http://www.captain-whu.com/project/SCD/">SECOND structure</a> with the addition of a GeoJSON with the vectorial representation of the change features and a <code>tiles_meta.csv</code> file containing metadata about the resulting change detection tiles. The repository <code>dataset/pits</code> folder contains a <code>dvc.yaml</code> file containing the configuration for some change detection datasets for some studied sites.</p>
<p>For example, a geographical train/test split of a site data is configured as:</p>
<pre><code class="language-yaml">stages:
  build_train_SITE:
    wdir: ../../.
    cmd:
      - rm -rf dataset/pits/train_SITE
      - mkdir -p dataset/pits/train_SITE
      - python src/alceo/processing/pits_site_dataset.py
        -s data/sites/SITE
        -o dataset/pits/train_SITE
        -a data/sites/SITE/train_area.geojson
    deps:
      - src/alceo/processing/pits_site_dataset.py
      - data/sites/SITE/tiles
      - data/sites/SITE/change
      - data/sites/SITE/train_area.geojson
    outs:
      - dataset/pits/train_SITE
  build_test_SITE:
    wdir: ../../.
    cmd:
      - rm -rf dataset/pits/test_SITE
      - mkdir -p dataset/pits/test_SITE
      - python src/alceo/processing/pits_site_dataset.py
        -s data/sites/SITE
        -o dataset/pits/test_SITE
        -a data/sites/SITE/test_area.geojson
    deps:
      - src/alceo/processing/pits_site_dataset.py
      - data/sites/SITE/tiles
      - data/sites/SITE/change
      - data/sites/SITE/test_area.geojson
    outs:
      - dataset/pits/test_SITE
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.indexes"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>